<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Business Simulation Game</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { color: #2c3e50; }
        table { border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #999; padding: 8px; text-align: center; }
        h2 { margin-top: 40px; color: #2c3e50; }
        ul { line-height: 1.6; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Business Simulation Game</h1>

    <h2>Your Decisions</h2>
    <form id="decisionForm">
        <table>
            <tr>
                <th></th>
                <th>NA</th>
                <th>EU</th>
                <th>APAC</th>
            </tr>
            <tr>
                <td>Price</td>
                <td><input type="number" name="na_price" value="600" min="500" max="700"></td>
                <td><input type="number" name="eu_price" value="600" min="500" max="700"></td>
                <td><input type="number" name="apac_price" value="600" min="500" max="700"></td>
            </tr>
            <tr>
                <td>Marketing</td>
                <td><input type="number" name="na_mkt" value="5" min="2" max="6"></td>
                <td><input type="number" name="eu_mkt" value="3" min="2" max="6"></td>
                <td><input type="number" name="apac_mkt" value="4" min="2" max="6"></td>
            </tr>
            <tr>
                <td>Production Allocation</td>
                <td><input type="number" name="na_alloc" value="60000" min="30000" max="100000"></td>
                <td><input type="number" name="eu_alloc" value="60000" min="30000" max="100000"></td>
                <td><input type="number" name="apac_alloc" value="80000" min="30000" max="100000"></td>
            </tr>
        </table>
        R&amp;D: <input type="number" name="rd" value="10" min="0" max="10">
        HR: <input type="number" name="hr" value="5" min="0" max="10">
        <br><br>
        <button type="submit">Next Round</button>
    </form>

    <p>
        <a href="/full-report">View Full Report</a> |
        <a href="/history">View Round History</a> |
        <a href="/rules" target="_blank">üìñ View Rules</a>
    </p>

    <div id="results">
        <canvas id="chart" width="600" height="300"></canvas>
        <div id="final"></div>
    </div>

    <script>
        const ctx = document.getElementById("chart").getContext("2d");
        const chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [
                    { label: "You", borderColor: "blue", fill: false, data: [] },
                    { label: "Competitor A", borderColor: "red", fill: false, data: [] },
                    { label: "Competitor B", borderColor: "green", fill: false, data: [] }
                ]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        document.getElementById("decisionForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/submit-ajax", { method: "POST", body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.history) {
                    chart.data.labels = data.history.rounds;
                    chart.data.datasets[0].data = data.history.svi["You"];
                    chart.data.datasets[1].data = data.history.svi["Competitor A"];
                    chart.data.datasets[2].data = data.history.svi["Competitor B"];
                    chart.update();
                }

                if (data.game_over) {
                    document.querySelector("button").disabled = true;
                    let resultHTML = "<h3>üèÜ Final Placements</h3><ol>";
                    data.placements.forEach(p => {
                        resultHTML += `<li>${p[0]} ‚Äì SVI: ${p[1].toFixed(2)}</li>`;
                    });
                    resultHTML += "</ol>";
                    resultHTML += `<button id="newGameBtn">üîÑ New Game</button>`;
                    document.getElementById("final").innerHTML = resultHTML;

                    document.getElementById("newGameBtn").addEventListener("click", () => {
                        fetch("/reset-game", { method: "POST" })
                        .then(res => res.json())
                        .then(() => {
                            location.reload();
                        });
                    });
                }
            });
        });
    </script>
</body>
</html>
